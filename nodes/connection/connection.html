<script type="text/javascript">

    RED.nodes.registerType('eip-io connection',{
        category: 'config',
        defaults: {
            name: {value:""},
            scanner: {value: "", type: "eip-io scanner"},
            address: {value: "0.0.0.0"},
            cfgAss: {value: 100},
            cfgSize: {value: 0},
            inputAss: {value: 101},
            inputSize: {value: 0},
            outputAss: {value: 102},
            outputSize: {value: 0},
            rpi: {value: 20},
            cfgData: {value: []},
            edsFile: {value: ''},
            edsObj: {value: {}},
            edsConnection: {value: "Connection1"},
            edsConnectionTypes: {value: [ {value: "Connection1", label: "Connection1"}]}
        },
        label: function() {
            return this.name||this.address;
        },
        oneditprepare: function() {
            let node = this
            let configDataHeader = $("<div>").append($.parseHTML("<div style='width:90%; display: inline-grid'>Index, Bit Size, Data, Description</div>"))
            $('#node-config-input-cfgData-container').css('min-height','150px').css('min-width','450px').editableList({
                addButton: false,
                height: 300,
                addItem: function(row, index, data) {
                    row.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    let fragment = document.createDocumentFragment();
                    let row1 = $('<div/>',{style:"display:flex; align-items: baseline"}).appendTo(fragment);
                    $('<span>', {style: 'padding-right: 5px'}).html(index.toString() + ' ').appendTo(row1)
                    let cfgDataSize = $('<input/>',{class: "node-config-input-cfg-data-size",type:"text"})
                        .appendTo(row1)
                        .typedInput({type: 'num'})
                        .typedInput('width', '10%');
                    let selections
                    if (node.configAssembly) {
                        if (node.configAssembly.params[index].enum) {
                            selections = node.configAssembly.params[index].enum.map(en => ({value: en.value.toString(), label: en.name.slice(1,-1)}))
                        }
                    }
                    let cfgValue = $('<input/>',{class: "node-config-input-cfg-data-value",type:"text"})
                        .appendTo(row1);
                    if (selections) {
                        cfgValue = cfgValue.typedInput({type: 'num', types: [{options: selections, value: node.configAssembly.params[index].info.defaultValue.toString()}]})
                    } else {
                        cfgValue = cfgValue.typedInput({type: 'num'})
                    }
                    cfgValue.typedInput('width', '30%')
                    let cfgDescription = $('<input/>',{class: "node-config-input-cfg-data-description",type:"text"})
                        .appendTo(row1)
                        .typedInput({type: 'str'})
                        .typedInput('width', '60%')
                
                    if (node.configAssembly) {
                        if (node.configAssembly.params[index]) {
                            cfgDataSize.typedInput('value', node.configAssembly.params[index].size);
                            cfgValue.typedInput('value', node.configAssembly.params[index].info.defaultValue.toString());
                            cfgDescription.typedInput('value', node.configAssembly.params[index].info.name.slice(1,-1))
                        }
                    }

                    if (data && data.size !== undefined) cfgDataSize.typedInput('value', data.size);
                    if (data && data.data !== undefined) cfgValue.typedInput('value', data.data.toString());
                    if (data && data.description !== undefined) cfgDescription.val( data.description)
                    
                    row[0].appendChild(fragment);

                },
                header: configDataHeader
    
            });
            let cfgSize = $('#node-config-input-cfgSize');
            cfgSize.change(()=> {
                $('#node-config-input-cfgData-container').editableList('empty')
                if (parseInt(cfgSize.val()) > 0 && !(this.configAssembly)) {
                    for (let i = 0; i < parseInt(cfgSize.val()); i++) {
                        $('#node-config-input-cfgData-container').editableList('addItem', this.cfgData[i]) 
                    }
                } else {
                    if (this.configAssembly) {
                        for (let i = 0; i < this.configAssembly.params.length; i++) {
                            $('#node-config-input-cfgData-container').editableList('addItem', this.cfgData[i])
                        }
                    }
                }
            });

            //EDS Editor
            this.EDSedit = RED.editor.createEditor({
                id: 'node-config-input-eds-file',
                mode: 'ace/mode/text',
                value: this.edsFile
            });

            $('#node-config-input-eds-file').on("drop", e => {
                let node = this
                e.preventDefault();
                e.stopPropagation();
                let file = e.originalEvent.dataTransfer.files[0];
                let reader = new FileReader();
                reader.onload = re => {
                    node.cfgData = [];
                    node.EDSedit.setValue(re.target.result)
                    node.edsObj = Serafintech.ParseEDS(node.EDSedit.getValue())
                    let connections = Object.keys(node.edsObj.ConnectionManager).filter(k => k.slice(0,10) === 'Connection' && node.edsObj.ConnectionManager[k].triggerAndTransport === 67174402);
                    node.edsConnectionTypes = connections.map(c => ({value: c, label: c + ':' + node.edsObj.ConnectionManager[c].connectionName.slice(1,-1)}))
                    $('#node-config-input-edsConnection').typedInput('types',[{options: node.edsConnectionTypes}])
                }
                reader.readAsText(file, "UTF-8");
            });
            $('#node-config-input-eds-file').on("dragenter dragover", e => {
                e.preventDefault();
            });
            $('#node-config-input-edsConnection').typedInput({types: [{value: this.edsConnection, options: this.edsConnectionTypes}]});
            $('#node-config-input-edsConnection').change(() => {
                let conn = this.edsObj.ConnectionManager[$('#node-config-input-edsConnection').val()];
                this.inputAssembly = Serafintech.GetAssembly(this.edsObj, conn.TOformat.slice(5));
                this.outputAssembly = Serafintech.GetAssembly(this.edsObj, conn.OTformat.slice(5));
                if(conn.proxyConfigFormat.length > 0) this.configAssembly = Serafintech.GetAssembly(this.edsObj, conn.proxyConfigFormat.slice(5));
                if(conn.targetConfigFormat.length > 0) this.configAssembly = Serafintech.GetAssembly(this.edsObj, conn.targetConfigFormat.slice(5));
                //console.log(conn, inputAssembly, outputAssembly, configAssembly);
                $('#node-config-input-cfgAss').val(this.configAssembly.id);
                $('#node-config-input-cfgSize').val(this.configAssembly.size).trigger('change');
                $('#node-config-input-inputAss').val(this.inputAssembly.id);
                $('#node-config-input-inputSize').val(this.inputAssembly.size);
                $('#node-config-input-outputAss').val(this.outputAssembly.id);
                $('#node-config-input-outputSize').val(this.outputAssembly.size);
            });
            

            

        },
        oneditsave: function() {
            let node = this;
            let configDataList = $('#node-config-input-cfgData-container');
            node.cfgData = [];

            let items = configDataList.editableList('items')

            items.each(function(i) {
                let line = $(this)
                let cfgSize = line.find('.node-config-input-cfg-data-size').typedInput('value');
                let cfgData = line.find('.node-config-input-cfg-data-value').typedInput('value');
                let cfgDescription = line.find('.node-config-input-cfg-data-description').val();
                node.cfgData.push({
                    size: cfgSize,
                    data: cfgData,
                    description: cfgDescription
                })
            })

            this.edsFile = this.EDSedit.getValue();
            this.EDSedit.destroy();
            delete this.EDSedit;
            
        },
        oneditcancel: function() {
            this.EDSedit.destroy();
            delete this.EDSedit;
        }
    });
</script>

<script type="text/html" data-template-name="eip-io connection">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-scanner">Scanner</label>
        <input type="text" id="node-config-input-scanner" placeholder="Scanner">
    </div>
    <div class="form-row">
        <label for="node-config-input-address">Address</label>
        <input type="text" id="node-config-input-address" placeholder="Address">
    </div>

    <div class="form-row">
        <label for="node-config-input-cfgAss">Config Assembly</label>
        <input type="text" id="node-config-input-cfgAss" placeholder="Config">
    </div>
    <div class="form-row">
        <label for="node-config-input-cfgSize">Config Size</label>
        <input type="text" id="node-config-input-cfgSize" placeholder="Config Size">
    </div>

    <div class="form-row">
        <label for="node-config-input-inputAss">Input Assembly</label>
        <input type="text" id="node-config-input-inputAss" placeholder="Input">
    </div>
    <div class="form-row">
        <label for="node-config-input-inputSize">Input Size</label>
        <input type="text" id="node-config-input-inputSize" placeholder="Input Size">
    </div>
    
    <div class="form-row">
        <label for="node-config-input-outputAss">Output Assembly</label>
        <input type="text" id="node-config-input-outputAss" placeholder="Output">
    </div>
    <div class="form-row">
        <label for="node-config-input-outputSize">Output Size</label>
        <input type="text" id="node-config-input-outputSize" placeholder="Output Size">
    </div>

    <div class="form-row">
        <label for="node-config-input-rpi">RPI</label>
        <input type="text" id="node-config-input-rpi" placeholder="RPI">
    </div>
    <div class="form-row node-config-input-cfgData-container-row">
        <label for="node-config-input-cfgData-container">Config Data</label>
        <ol id="node-config-input-cfgData-container"></ol>
    </div>
    <div class="form-row">
        <label for="node-config-input-eds-file">EDS File</label>
        <div style="height: 250px; min-height: 150px;" class="node-text-editor" id="node-config-input-eds-file"></div>
    </div>
    <div class="form-row">
        <label for="node-config-input-edsConnection">Connection</label>
        <input type="text" id="node-config-input-edsConnection">
    </div>
</script>

<script type="text/markdown" data-help-name="eip-io connection">
Ethernet/IP IO Device Connection 

### Details   

Assembly configuration will need to be supplied by manufacturer literature.

`rpi` is the communication update rate to the Ethernet/IP device in milliseconds.

### Warning

Caution when using in production devices

**Fully test everything!** The authors cannot be liable for any
damage or injury caused by the use of this node. 
</script>