<script type="text/html" data-template-name="eip-io connection">
    <style>
        .red-ui-editor .form-row label {
            width: 125px;
        }

        #node-config-input-configdata-row .red-ui-editableList-container {
            padding: 0px;
        }

        #node-config-input-configdata-row .red-ui-editableList-container li {
            padding: 0px;
        }

        #node-config-input-configdata-row .red-ui-editableList-item-remove {
            right: 5px;
        }

        #node-config-input-configdata-row .red-ui-editableList-header {
            display: flex;
            background: var(--red-ui-tertiary-background);
            border-top-left-radius: 3px;
            border-top-left-radius: 3px;
        }

        #node-config-input-configdata-row .red-ui-editableList-header > div:nth-child(1) {
            width: 10%;
        }

        #node-config-input-configdata-row .red-ui-editableList-header > div:nth-child(2) {
            width: 40%;
        }

        #node-config-input-configdata-row .red-ui-editableList-header > div:nth-child(3) {
            flex-grow: 1
        }

        .node-configdata-entry {
            display: flex;
        }

        .node-configdata-entry > span > input[type="text"] {
            border-radius: 0;
            border-top-color: var(--red-ui-form-background);
            border-bottom-color: var(--red-ui-form-background);
            border-right-color: var(--red-ui-form-background);
        }

        .node-configdata-entry > span:nth-child(1) {
            width: 10%;
            position: relative;
        }

        .node-configdata-entry > span:nth-child(2) {
            width: 40%;
            position: relative;
        }

        .node-configdata-entry > span:nth-child(3) {
            flex-grow: 1;
            position: relative;
        }

        .node-configdata-entry span .node-input-config-datasize-val,  .node-configdata-entry span .node-input-config-datavalue-val, .node-configdata-entry span .node-input-config-datadesc-val {
            width: 100%
        }

        .node-configdata-entry .red-ui-typedInput-container {
            border-radius: 0;
            border: none;
        }

        .node-configdata-entry span .red-ui-typedInput-container {
            width: 100%
        }

        .node-configdata-entry > span > span > i {
            display: none;
        }


    </style>

    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-config-input-scanner"><i class="fa fa-cube"></i> Scanner</label>
        <input type="text" id="node-config-input-scanner" placeholder="Scanner">
    </div>

    <div class="form-row conn-tabs-row">
        <ul style="min-width: 500px; margin-bottom: 20px;" id="conn-tabs"></ul>
    </div>

    <div id="conn-tabs-content" style="min-height: calc(100% - 95px)">
        
        <div id="conn-tab-setup" style="display:none">
            <div class="form-row">
                <label for="node-input-ipaddress"><i class="fa fa-location-arrow"></i> IP Address</label>
                <input type="text" id="node-config-input-ipaddress">
            </div>

            <div class="form-row">
                <label for="node-input-rpi"><i class="fa fa-repeat"></i> RPI</label>
                <input type="text" id="node-config-input-rpi" class="st-integer-entry" style="width: 50px;">
            </div>
        
            <div class="form-row">
                <label for="node-input-aconfig"><i class="fa fa-cog"></i> Config Assembly</label>
                <input type="text" id="node-config-input-assconfig"  style="width: 50px;">
            </div>
            <div class="form-row">
                <label for="node-input-sizeconfig"><i class="fa fa-cog"></i> Config Size</label>
                <input type="text" id="node-config-input-sizeconfig"  style="width: 50px;">
            </div>
        
            <div class="form-row">
                <label for="node-input-assinput"><i class="fa fa-sign-in"></i> Input Assembly</label>
                <input type="text" id="node-config-input-assinput"  style="width: 50px;">
            </div>

            <div class="form-row">
                <label for="node-input-sizeinput"><i class="fa fa-sign-in"></i> Input Size</label>
                <input type="text" id="node-config-input-sizeinput"  style="width: 50px;">
            </div>
            
            <div class="form-row">
                <label for="node-input-assoutput"><i class="fa fa-sign-out"></i> Output Assembly</label>
                <input type="text" id="node-config-input-assoutput"  style="width: 50px;">
            </div>

            <div class="form-row">
                <label for="node-input-sizeoutput"><i class="fa fa-sign-out"></i> Output Size</label>
                <input type="text" id="node-config-input-sizeoutput"  style="width: 50px;">
            </div>
        
        </div>

        <div id="conn-tab-config" style="display:none">
            <div class="form-row node-input-configdata-row hide" style="margin-bottom: 0px;">
                <label><i class="fa fa-cubes"></i> Config Data</label>
            </div>
            <div class="form-row node-input-configdata-row hide" id="node-config-input-configdata-row">
                <ol id="node-config-input-configdata-container"></ol>
            </div>
        </div>

        <div id="conn-tab-eds" style="display:none">
            <div class="form-row">
                <label><i class="fa fa-file"></i> EDS File</label>
            </div>
            <div class="form-row">
                <div style="height: 250px; min-height: 150px;" class="node-text-editor" id="eds-editor"></div>
            </div>
            <div class="form-row">
                <input type="text" id="node-config-input-connection">
                <button type="button" class="red-ui-button" id="set-conn-button">Set Connection</button>
            </div>
            <div class="form-row">
                <div id="eds-error" class="hide" style="color: red"><i class="fa fa-exclamation-triangle"></i> EDS Invalid</div>
            </div>
        </div>

    </div>
</script>
<script type="text/markdown" data-help-name="eip-io connection">
Ethernet/IP IO connection node.

Configure IP address and connection assembly and size information from manufacturer's documentation.

### Details

## **Setup** tab
`IP Address` - Enter IP address of device. `RPI` is how many milliseconds between scans. `Config`, `Input`, `Output` Assemblies and Sizes are the connection configuration information

## **Config** tab
This is where configuration data is entered.  This is only needed if the Config size is > 0 and you would like to change the default configuration of the device.  See manufacturers documentation.

## **EDS** tab
This is where a devices EDS file can either be dragged-and-dropped or cut-and-pasted into the text area.  If compatible, you will be able to automatically configure the assemblies and config data table by selecting a connection and clicking `Set Connection`

### Warning

Caution when using in production devices

**Fully test everything!** The authors cannot be liable for any
damage or injury caused by the use of this node.
</script>

<script type="text/javascript">
(function () {

    function setupTabs() {
        let tabs = RED.tabs.create({
                id: "conn-tabs",
                onchange: function(tab) {
                    $("#conn-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });

            tabs.addTab({
                id: "conn-tab-setup",
                iconClass: "fa fa-wrench",
                label: "Setup"
            });

            tabs.addTab({
                id: "conn-tab-config",
                label: "Config",
                iconClass: "fa fa-cogs"
            });

            tabs.addTab({
                id: "conn-tab-eds",
                label: "EDS",
                iconClass: "fa fa-file-text-o"
            });
    }

    function setupConfigData() {

        $(".node-input-configdata-row").show();

        let configDataList = $('#node-config-input-configdata-container').css('min-height','300px').css('min-width','450px').editableList({
            header: $('<div><div>Bits</div><div>Value</div><div>Description</div>'),
            removable: true,
            buttons: [{
                label: "clear",
                icon: "fa fa-ban",
                name: "Clear Config Data List",
                click: function() {
                    configDataList.editableList('empty');
                }
            }],
            addItem: function(container, i, opt) {
                
                let row0 = $("<div/>").addClass("node-configdata-entry").appendTo(container)
                let configSizeSpan = $('<span>').appendTo(row0)
                let configSize = $("<input/>", {
                    class: "node-input-config-datasize-val",
                    type: "text"
                }).css({
                }).appendTo(configSizeSpan);

                let configValueSpan = $('<span>').appendTo(row0);
                let configValue = $("<input/>", {
                    class: "node-input-config-datavalue-val",
                    type: "text"
                }).css({
                }).appendTo(configValueSpan).typedInput({
                    type: 'num',
                    types: ["num", "bin"]
                });
                
                let configDescSpan = $('<span>').appendTo(row0);
                let configDesc = $("<input/>", {
                    class: "node-input-config-datadesc-val",
                    type: "text"
                }).css({
                }).appendTo(configDescSpan);

                let configDecimalsSpan = $('<span>', {class: "hide"}).appendTo(row0);
                let configDecimals = $("<input/>", {
                    class: "node-input-config-datadecimals-val",
                    type: "text" 
                }).css({
                }).appendTo(configDecimalsSpan);

                let configDataTypeSpan = $('<span>', {class: "hide"}).appendTo(row0);
                let configDataType = $("<input/>", {
                    class: "node-input-config-datatype-val",
                    type: "text" 
                }).css({
                }).appendTo(configDataTypeSpan);

                configSize.val(opt.size);

                if(opt.valueObj) {
                    let multiple = undefined;
                    let v = opt.valueObj.value
                    if (opt.valueObj.options && opt.valueObj.maxValue) {
                        if (Math.max(...opt.valueObj.options.map(o=>Number(o.value))) < Number(opt.valueObj.maxValue)) {
                            multiple = "true"
                            v = (v >>> 0).toString(2).split("").reduce((p,c,i,a) => {
                                
                            }, "")
                        }
                    }
                    if (opt.valueObj.options) {
                        configValue.typedInput('types', [{options: opt.valueObj.options, multiple: multiple}]);
                        configValue.typedInput('value', v)
                    } else {
                        configValue.typedInput('value', v);
                    }

                    if (opt.valueObj.decimalPlaces) {
                        configDecimals.val(opt.valueObj.decimalPlaces);
                    } else {
                        configDecimals.val('0');
                    }
                    configDataType.val(opt.valueObj.type)
                }
                configDesc.val(opt.description);
            }
            });
    }

    function setupEdsEditor(that) {
        
        $('#node-config-input-connection').typedInput({types: [{options: that.connections}]})

        that.EDSedit = RED.editor.createEditor({
            id: 'eds-editor',
            mode: 'ace/mode/text',
            value: that.edsfile
        });

        $('#eds-editor').on("drop", e => {
            $('#eds-error').hide()
            e.preventDefault();
            e.stopPropagation();
            let file = e.originalEvent.dataTransfer.files[0];
            let reader = new FileReader();
            reader.onload = re => {  
                that.EDSedit.setValue(re.target.result);  
            }
            reader.readAsText(file, "UTF-8");
        });
        $('#eds-editor').on("dragenter dragover", e => {
            e.preventDefault();
        });

        that.EDSedit.session.on('change', () => {
            $('#eds-error').hide();
            try {
                    readEdsConnections(that);
                } catch (e) {
                    console.log(e)
                    console.log("EDS Read Error!");
                    $('#eds-error').show();
                }
        })
    }

    function readEdsConnections(that) {
        let edsObj = Serafintech.ParseEDS(that.EDSedit.getValue())
        let conns = Object.keys(edsObj.ConnectionManager).filter(k => k.slice(0,10) === 'Connection' );
        that.connections = conns.map(c => ({value: c, label: c + ':' + edsObj.ConnectionManager[c].connectionName.slice(1,-1)}))
        $('#node-config-input-connection').typedInput('types',[{options: that.connections}])
    }
    
    function setConnectionEvent(that) {
        $('#set-conn-button').click(() => {
                $('#eds-error').hide();
                try {
                    let edsObj = Serafintech.ParseEDS(that.EDSedit.getValue());
                    let conn = edsObj.ConnectionManager[$('#node-config-input-connection').val()];

                    let inputAssembly = Serafintech.GetAssembly(edsObj, conn.TOformat.slice(5));
                    let outputAssembly = Serafintech.GetAssembly(edsObj, conn.OTformat.slice(5));
                    let configAssembly;
                    //if(conn.proxyConfigFormat.length > 0) configAssembly = Serafintech.GetAssembly(edsObj, conn.proxyConfigFormat.slice(5));
                    configAssembly = Serafintech.GetAssembly(edsObj, conn.targetConfigFormat.slice(5));

                    $('#node-config-input-assconfig').val(configAssembly.id);
                    $('#node-config-input-sizeconfig').val(configAssembly.size)
                    $('#node-config-input-assinput').val(inputAssembly.id);
                    $('#node-config-input-sizeinput').val(inputAssembly.size);
                    $('#node-config-input-assoutput').val(outputAssembly.id);
                    $('#node-config-input-sizeoutput').val(outputAssembly.size);

                    $('#node-config-input-configdata-container').editableList('empty');
                    let computeSize = 0
                    for (let i = 0; i < configAssembly.params.length; i++) {
                        
                        let addItem = (param) => {
                            let size = Number(param.size).toString();
                            let value = (param.info.defaultValue) ? param.info.defaultValue.toString() : (param.value !== undefined) ? param.value.toString() : (0).toString()
                            
                            value = (param.info.decimalPlaces !== undefined && !isNaN(param.info.decimalPlaces)) ? (Number(value) / Math.pow(10, param.info.decimalPlaces)).toFixed(param.info.decimalPlaces) : value;
                            
                            $('#node-config-input-configdata-container').editableList('addItem', {
                                size: size,
                                valueObj: {
                                    options: (param.enum) ? param.enum.map(en => ({value: en.value.toString(), label: en.name.slice(1,-1)})) : undefined , 
                                    value: value,
                                    decimalPlaces: (param.info.decimalPlaces !== undefined && !isNaN(param.info.decimalPlaces)) ? param.info.decimalPlaces : 0,
                                    type: param.info.dataType,
                                    maxValue: param.info.maxValue
                                },
                                description: (param.info.name) ? param.info.name.slice(1,-1) : ""
                            });
                        }
                        
                        if(configAssembly.params[i].name.slice(0,5) === 'Assem') {
                            for (let j = 0; j < configAssembly.params[i].info.params.length; j++) {
                                addItem(configAssembly.params[i].info.params[j])
                            }
                        } else {
                            addItem(configAssembly.params[i])
                        }                       
                    }                    
                } catch (e) {
                    console.log(e)
                    $('#eds-error').show()
                }
            })
    }

    RED.nodes.registerType('eip-io connection',{
        category: 'config',
        defaults: {
            name: {value:""},
            scanner: {value: "", type: "eip-io scanner"},
            ipaddress: {value: "0.0.0.0"},
            rpi: {value: 50},
            assconfig: {value: 0},
            sizeconfig: {value: 0},
            assinput: {value: 0},
            sizeinput: {value: 0},
            assoutput: {value: 0},
            sizeoutput: {value: 0},
            edsfile: {value: 'Drop EDS File Here!'},
            connection: {value: ''},
            connections: {value: [{value: '', label: 'No Connections'}]},
            configdata: {value: []}     
        },
        label: function() {
            return this.name||this.ipaddress;
        },
        oneditprepare: function() {
            let that = this;
            setupTabs();
            setupConfigData();
            setupEdsEditor(that);
            
            try {
                readEdsConnections(that);
            } catch (e) {
                $('#eds-error').show();
                console.log(e)
            }

            setConnectionEvent(that); 
            

            // Init Config Data
            try {
                let edsObj = Serafintech.ParseEDS(that.EDSedit.getValue());
                let configAssembly = Serafintech.GetAssembly(edsObj, that.assconfig);
                that.configdata.forEach((item, i) => {
                $('#node-config-input-configdata-container').editableList('addItem', {
                    size: item.size,
                    valueObj: {
                        options: (configAssembly.params[i].enum) ? configAssembly.params[i].enum.map(en => ({value: en.value.toString(), label: en.name.slice(1,-1)})) : undefined , 
                        value: item.value,
                        decimalPlaces: (configAssembly.params[i].info.decimalPlaces !== undefined && !isNaN(configAssembly.params[i].info.decimalPlaces)) ? configAssembly.params[i].info.decimalPlaces : undefined,
                        type: configAssembly.params[i].info.dataType,
                        maxValue: configAssembly.params[i].info.maxValue
                    },
                    description: item.description
                });
            })
            } catch (e) {
                that.configdata.forEach((item, i) => {
                    $('#node-config-input-configdata-container').editableList('addItem', {
                        size: item.size,
                        valueObj: {
                            options: undefined , 
                            value: item.value
                        },
                        description: item.description
                    });
                });  
            }           
        },
        oneditsave: function() {
            this.edsfile = this.EDSedit.getValue();          
            
            let that = this;
            let configDataList =  $('#node-config-input-configdata-container').editableList('items');
            that.configdata = [];
            configDataList.each(function(i, item) {
                let row = $(item);
                that.configdata.push({
                    size: row.find('.node-input-config-datasize-val').val(),
                    value: row.find('.node-input-config-datavalue-val').typedInput('value'),
                    description: row.find('.node-input-config-datadesc-val').val(),
                    decimals: row.find('.node-input-config-datadecimals-val').val(),
                    type: row.find('.node-input-config-datatype-val').val()
                });
            });
            
            this.EDSedit.destroy();
            delete this.EDSedit;
            
        },
        oneditcancel: function() {
            this.EDSedit.destroy();
            delete this.EDSedit;
        }

    });
})();
</script>